# Jupyter Notebook Code Execution Feature - Setup Guide

## Overview
This implementation adds a **notebook** artifact type to your AI chatbot that allows users to execute Python code in a sandboxed E2B environment. The code is generated by Claude AI and executed safely with data science libraries pre-installed.

## ‚úÖ What's Been Implemented

### 1. **Core Files Created**
- `artifacts/notebook/server.ts` - E2B code execution backend
- `artifacts/notebook/client.tsx` - React UI component for notebook display
- Updated type definitions in `lib/types.ts`
- Updated artifact registry in `lib/artifacts/server.ts` and `components/artifact.tsx`

### 2. **Features**
- ‚úÖ Python code generation via Claude AI
- ‚úÖ Sandboxed code execution using E2B CodeInterpreter
- ‚úÖ Real-time code streaming as it's generated
- ‚úÖ Execution results display (stdout, stderr, errors)
- ‚úÖ Support for matplotlib plots (base64 encoded images)
- ‚úÖ Code editor with Python syntax highlighting
- ‚úÖ Console output viewer
- ‚úÖ Copy code to clipboard
- ‚úÖ Request code modifications via chat

### 3. **Available Python Libraries**
Pre-installed in E2B environment:
- **Data Science**: numpy, pandas, scipy, scikit-learn
- **Visualization**: matplotlib, seaborn, plotly
- **Image Processing**: opencv-python, pillow, scikit-image
- **Text/NLP**: nltk, spacy
- **File Handling**: openpyxl, python-docx
- **Utilities**: requests, beautifulsoup4

## üîß Setup Instructions

### Step 1: Get E2B API Key
1. Go to https://e2b.dev/
2. Sign up for a free account (free tier available)
3. Navigate to https://e2b.dev/docs/getting-started/api-key
4. Copy your API key

### Step 2: Add API Key to Environment
Add this to your `.env.local` file:

```bash
E2B_API_KEY=your_e2b_api_key_here
```

### Step 3: Install Dependencies (Already Done)
The package `@e2b/code-interpreter` has already been installed.

### Step 4: Test the Feature
1. Start your development server:
   ```bash
   pnpm dev
   ```

2. In the chat, try these example prompts:
   - "Create a data analysis notebook that generates random data and plots it"
   - "Write Python code to calculate fibonacci numbers and visualize them"
   - "Analyze this data: [paste CSV data]"

3. When creating a document, Claude should now offer "notebook" as an artifact type option

## üìù How It Works

```
User Prompt
    ‚Üì
Claude AI (with notebook system prompt)
    ‚Üì
Generate Python Code
    ‚Üì
Stream code to UI (user sees it being written)
    ‚Üì
E2B Sandbox Execution (secure, isolated)
    ‚Üì
Collect Results (stdout, stderr, images)
    ‚Üì
Display in Console UI
```

## üéØ Usage Examples

### Example 1: Data Analysis
**User:** "Create a notebook that analyzes sales data"

**Claude generates:**
```python
import pandas as pd
import matplotlib.pyplot as plt

# Sample sales data
data = {
    'month': ['Jan', 'Feb', 'Mar', 'Apr'],
    'sales': [1000, 1500, 1200, 1800]
}
df = pd.DataFrame(data)

print("Sales Summary:")
print(df.describe())

plt.bar(df['month'], df['sales'])
plt.title('Monthly Sales')
plt.xlabel('Month')
plt.ylabel('Sales ($)')
plt.show()
```

**Result:** User sees the code, summary statistics, and a bar chart

### Example 2: Data Visualization
**User:** "Plot a sine wave with matplotlib"

**Claude generates:**
```python
import numpy as np
import matplotlib.pyplot as plt

x = np.linspace(0, 2 * np.pi, 100)
y = np.sin(x)

plt.plot(x, y)
plt.title('Sine Wave')
plt.xlabel('x')
plt.ylabel('sin(x)')
plt.grid(True)
plt.show()
```

**Result:** User sees a nice sine wave graph

## üîí Security Features

1. **Sandboxed Execution**: Code runs in isolated E2B containers
2. **Timeout Protection**: 5-minute maximum execution time
3. **No Package Installation**: Users cannot install arbitrary packages
4. **Network Isolation**: Limited network access
5. **Resource Limits**: CPU and memory constraints

## üöß Current Limitations

1. **File Upload**: Not yet implemented (TODO in code)
2. **Single Cell Execution**: Only one code block per artifact (not multi-cell notebook)
3. **No State Persistence**: Each execution is fresh (no variable persistence between runs)
4. **Image Format**: Only PNG images supported currently
5. **No Interactive Plots**: Plotly/Bokeh interactive charts not yet rendered

## üîÆ Future Enhancements

### High Priority
- [ ] File upload support (CSV, Excel, JSON)
- [ ] Multi-cell notebook execution (like Jupyter)
- [ ] Persistent kernel state across cells
- [ ] Better error messages with line numbers
- [ ] Execution time/resource usage display

### Nice to Have
- [ ] Interactive plot support (Plotly)
- [ ] Dataframe viewer (like pandas profiling)
- [ ] Variable inspector panel
- [ ] Execution history
- [ ] Download results as .ipynb
- [ ] Collaborative editing
- [ ] Code autocomplete
- [ ] Built-in data sources (example datasets)

## üêõ Troubleshooting

### "E2B_API_KEY is not set"
- Make sure you added the key to `.env.local`
- Restart your dev server after adding the key
- Check for typos in the variable name

### Code execution times out
- E2B has a 5-minute timeout
- Optimize code to run faster
- Break into smaller chunks

### Package not found
- Check if the package is in the available libraries list above
- Cannot install new packages in E2B
- Find alternatives using available packages

### No output shown
- Check browser console for errors
- Ensure code has `print()` statements or `plt.show()` for visualizations
- Check E2B dashboard for execution logs

## üí∞ Cost Considerations

### E2B Pricing (as of 2025)
- **Free Tier**: 100 execution minutes/month
- **Hobby**: ~$10/month for more executions
- **Pro**: Custom pricing for high volume

### Recommendations
- Enable rate limiting per user
- Monitor usage via E2B dashboard
- Consider making it a premium feature
- Set execution time limits

## üìö Code Reference

### Key Files to Understand
1. `artifacts/notebook/server.ts` - Backend execution logic
2. `artifacts/notebook/client.tsx` - Frontend UI component
3. `lib/ai/prompts.ts` - Look for `notebookPrompt`
4. `lib/types.ts` - Type definitions for `NotebookExecution`

### Extending the Feature
To add new capabilities, edit:
- **System prompt**: `lib/ai/prompts.ts` ‚Üí `notebookPrompt`
- **Result types**: `lib/types.ts` ‚Üí `NotebookExecution`
- **UI display**: `artifacts/notebook/client.tsx` ‚Üí `onStreamPart`

## ü§ù Testing Checklist

Before going to production:
- [ ] Test with valid E2B API key
- [ ] Test code generation for various prompts
- [ ] Test error handling (syntax errors, runtime errors)
- [ ] Test timeout scenarios
- [ ] Test with matplotlib visualizations
- [ ] Test console output display
- [ ] Test copy functionality
- [ ] Test on mobile devices
- [ ] Load test with concurrent users
- [ ] Monitor E2B usage/costs

## üìû Support

- **E2B Documentation**: https://e2b.dev/docs
- **E2B Discord**: https://discord.gg/U7KEcGErtQ
- **E2B GitHub**: https://github.com/e2b-dev/code-interpreter

---

**Implementation Status**: ‚úÖ Complete and Ready for Testing

**Next Steps**: 
1. Add E2B_API_KEY to your environment
2. Restart dev server
3. Test with example prompts
4. Monitor usage and costs
